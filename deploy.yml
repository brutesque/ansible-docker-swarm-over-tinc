---

- name: Wait for nodes to become available
  hosts: all
  tasks:
  - wait_for_connection:
      delay: 10
      timeout: 600
  tags: waiting

- name: Setup Ubuntu
  hosts: all
  become: true
  roles:
    - setup_ubuntu
  vars_files:
    - vars/main.yml
  tags: ubuntu

- name: Mount the BigStorage disk
  hosts: storage
  become: true
  tasks:
    - name: Mount big storage device
      mount:
        path: "/mnt/storage"
        src: "/dev/{{ storage_device }}"
        fstype: xfs
        opts: defaults
        state: present
      when: storage_device is defined
  tags: storage

- name: Install Tinc
  hosts: vpn_mesh
  become: true
  roles:
    - tinc
  vars_files:
    - vars/main.yml
  tags: tinc

- name: Install Docker
  hosts: swarm
  become: true
  roles:
    - docker
  vars_files:
    - vars/main.yml
  tags: docker

- name: Setup Docker Swarm
  hosts: swarm
  become: true
  roles:
    - swarm
  vars_files:
    - vars/main.yml
  tags: swarm

- name: Deploy stacks
  hosts: managers[0]
  become: true
  roles:
    - stacks
  vars_files:
    - vars/main.yml
  tags: stacks

- name: Register ip at DuckDNS
  hosts: entrypoints
  become: true
  roles:
    - duckdns
  vars_files:
    - vars/main.yml
  tags: duckdns
