---

- name: Create admin password hash for stack
  set_fact:
    admin_password_hash: "{{ admin_password | password_hash('blowfish', rounds=12, salt=['reverse-proxy', fingerprint, filetime_result.stdout] | join('|') | hash('sha1') | truncate(22, True, '')) }}"
  run_once: true

- name: Create network for the reverse-proxy
  docker_network:
    state: present
    name: traefik-public
    scope: swarm
    driver: overlay
    attachable: yes
  run_once: true

- name: Create traefik secret
  docker_secret:
    name: traefik-pass
    data: "{{ ['admin', admin_password_hash] | join(':') | b64encode }}"
    data_is_b64: true
    state: present

- name: Copy reverse-proxy stack file
  copy:
    src: files/traefik-v1.stack.yml
    dest: /opt/stacks/traefik-v1.stack.yml
  run_once: true

- name: Deploy reverse-proxy stack
  docker_stack:
    state: present
    name: reverse-proxy
    compose:
      - /opt/stacks/traefik-v1.stack.yml
  environment:
    EMAIL: "{{ ca_email }}"
    DOMAIN: "admin.{{ domain_name }}"
    USERNAME: "admin"
    HASHED_PASSWORD: "{{ admin_password_hash }}"
    CONSUL_REPLICAS: 3
    TRAEFIK_REPLICAS: 3
  run_once: true
